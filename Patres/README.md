# Library API

RESTful API для управления библиотекой. Реализован на FastAPI 
с использованием SQLAlchemy, Alembic и JWT-аутентификации.


## Возможности

- Аутентификация библиотекарей через JWT
- CRUD для книг и читателей
- Выдача и возврат книг
- Валидация с Pydantic
- Покрытие тестами через Pytest


## Основной стек технологий

- Python
- FastAPI
- SQLAlchemy
- Alembic
- SQLite/PostgreSQL
- Pydantic
- Pytest


##Структура проекта

-- alembic/ - Миграции
-- database/ - Конфигурация бд и подключение
-- models/ - Модели бд(SQLAlchemy)
-- schema/ - Pydantic-схемы(валидации данных и сериализация)
-- routers/ - Эндпоинты(ручки)
-- services/ - Вспомогательные функции
-- test/ - Тесты(Pytest)
-- main.py - Основной файл запуска
-- requirements.txt - Зависимости(библиотеки необходимые для работы приложения)
-- прочие доп файлы конфигурации...



## Бизнес логика

1. По пунтку 4.1 - книга может быть выдана если есть доступное их количество:
   в ручке при выдаче книги идёт проверка на наличие книги и на её количество, если количество книги меньше 1, то
   ручка выдаст ошибку (if not book or if book.copies < 1: raise exception)

2. По пункту 4.2 - один читатель не может брать больше 3-х книг:
   При выдаче книги также идёт запрос на выданные книги. Если
   айдишки совпадают и количество выданных книг уже 3 и больше, 
   то идёт возвращаем ошибку и книгу не выдаём

3. По пункту 4.3 - Нельзя вернуть книгу, которая не была выдана этому читателю или уже возвращена:
   при возврате книги проверяется наличие книги, проверяется дата возврата(
   если дата возврата не определена, значит книга не выдана), сравниваются айдишки читателя.

## Аутентификация - реализация
Используется JWT для авторизации.

Библиотеки: 
   1. python-jose - для генерации/ декодирования токенов
   2. passlib - для хеширования паролей(bcrypt)

Эндпоинты /auth/register и /auth/login публичны.

Все остальные(кроме GET /books/) защищены через Depends(get_current_user) - т.е требуют JWT

Проверка токена:
   1. Декодируется токен.
   2. Получается user_id, по нему ищется пользователь
   3. Если всё валидно - даётся доступ


## Доп фича(творческая часть)

Думаю как доп фичу можно было бы добавить черный список читателей и т.д.
То есть читатель возможно помял книгу, вернул с задержкой или вовсе не вернул - это всё учитывать в программе.
Модель состоял бы из айдишки, айдишка читателей, можно поле комментария(причина блокировки и т.д), дата добавления в чс 
и дата разблокировки 

## Установка и запуск

```bash
git clone https://github.com/Shaba010820/My_projects/Patres
cd Patres
python -m venv venv
source venv/bin/activate или на Windows: venv\Scripts\activate
pip install -r requirements.txt
alembic upgrade head
uvicorn main:app --reload --port 8000


Также есть Docker compose с использованием Postgres вместо sqlite. 
Сборка по команде:

docker-compose up --build

Запуск тестов командой "pytest"


После запуска перейдите на http://localhost:8000/docs для просмотра Swagger UI(Регистрацию пользователя 
также лучше сделать здесь)
